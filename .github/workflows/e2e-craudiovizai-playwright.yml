name: E2E Tests - craudiovizai.com

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

permissions:
  contents: read
  issues: write

jobs:
  e2e-playwright:
    name: Playwright Critical Flows
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.48.0-jammy
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install dependencies
        run: npm install

      - name: Run Playwright tests
        id: tests
        run: |
          set +e
          npx playwright test --config=playwright.config.ts 2>&1 | tee test-output.log
          TEST_EXIT=$?
          echo "exit_code=$TEST_EXIT" >> $GITHUB_OUTPUT
          exit 0

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: playwright-results
          path: |
            playwright-report/
            test-results/
            test-output.log
          retention-days: 30

      - name: Check results and create issue if failed
        if: steps.tests.outputs.exit_code != '0'
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            let output = '';
            try {
              output = fs.readFileSync('test-output.log', 'utf8');
            } catch (e) {
              output = 'Could not read test output';
            }
            const runUrl = 'https://github.com/' + context.repo.owner + '/' + context.repo.repo + '/actions/runs/' + context.runId;
            const body = '## E2E Test Failure\n\n' +
              'Target: https://craudiovizai.com\n' +
              'Run: ' + runUrl + '\n' +
              'Time: ' + new Date().toISOString() + '\n\n' +
              '### Output\n```\n' + output.substring(output.length - 3000) + '\n```\n\n' +
              '[View full artifacts](' + runUrl + '#artifacts)';
            await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: '[E2E] Test failure on craudiovizai.com',
              body: body,
              labels: ['bug', 'e2e-failure']
            });

      - name: Fail if tests failed
        if: steps.tests.outputs.exit_code != '0'
        run: exit 1

      - name: Success
        if: steps.tests.outputs.exit_code == '0'
        run: echo "All E2E tests passed! /login verified."
